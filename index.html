<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
  <title>Arena Duel â€“ Mobile Fix</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      background: #0e1013;
      color: #eef;
      font-family: system-ui, sans-serif;
      height: 100%;
      overflow: hidden;
    }
    #topbar {
      background: #0e1013cc;
      color: #eef;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      height: 42px;
    }
    #mana {
      height: 10px;
      background: #22324a;
      border: 1px solid #2c3c54;
      border-radius: 6px;
      width: 160px;
      overflow: hidden;
    }
    #mana div {
      height: 100%;
      background: #61dafb;
      width: 0%;
      transition: width 0.1s linear;
    }
    #container {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
    }
    #stage {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #e7dfb5;
    }
    canvas {
      width: 100%;
      height: 100%;
      touch-action: none;
    }
    #ui {
      background: #0e1013dd;
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 8px;
    }
    .card, button {
      background: #1b2330;
      border: 1px solid #2c3c54;
      color: #eef;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 14px;
      min-width: 80px;
      text-align: center;
      user-select: none;
      touch-action: manipulation;
    }
    .card:active, button:active {
      transform: scale(0.96);
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="topbar">
      <strong>Arena Duel (MVP)</strong>
      <div id="mana"><div></div></div>
    </div>

    <div id="stage">
      <canvas id="game" width="720" height="1080"></canvas>
    </div>

    <div id="ui">
      <div class="card" data-cost="3" data-type="scout">Scout (3)</div>
      <div class="card" data-cost="4" data-type="tank">Tank (4)</div>
      <div class="card" data-cost="2" data-type="spark">Spark (2)</div>
      <button id="restart">Riavvia</button>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const manaBar = document.querySelector("#mana div");
    const W = 720, H = 1080;
    let scale = 1, offsetX = 0, offsetY = 0;
    let last = performance.now(), playing = true;

    const state = {
      mana: 5, maxMana: 10, regen: 0.015, t: 0, time: 0,
      playerTowers: [{x: W*0.12, y: H*0.65, hp: 100, max: 100}, {x: W*0.12, y: H*0.79, hp: 100, max: 100}],
      enemyTowers: [{x: W*0.88, y: H*0.65, hp: 100, max: 100}, {x: W*0.88, y: H*0.79, hp: 100, max: 100}],
      units: []
    };

    const rand = (a,b)=>a + Math.random()*(b-a);
    const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));

    function resize() {
      const stage = document.getElementById("stage");
      const w = stage.clientWidth;
      const h = stage.clientHeight;
      const aspect = 720/1080;
      let cw = w, ch = cw/aspect;
      if (ch > h) { ch = h; cw = ch*aspect; }
      canvas.width = cw;
      canvas.height = ch;
      scale = cw / W;
      offsetX = (cw - W*scale)/2;
      offsetY = (ch - H*scale)/2;
    }
    window.addEventListener("resize", resize);
    resize();

    function addUnit(team, lane, type){
      const y = [H*0.60,H*0.72,H*0.84][lane];
      const dir = team==='P'?1:-1;
      const x = team==='P'?W*0.20:W*0.80;
      let u = {team, x, y, dir, type, cd:0};
      if(type==='scout') Object.assign(u,{spd:0.8,hp:18,atk:3,range:14,rate:0.7});
      if(type==='tank') Object.assign(u,{spd:0.45,hp:60,atk:6,range:18,rate:1.2});
      if(type==='spark') Object.assign(u,{spd:0.7,hp:12,atk:8,range:70,rate:1.6});
      state.units.push(u);
    }

    function ai(dt){
      if(!playing) return;
      state.t += dt;
      if(rand(0,1) < 0.015){
        const m=Math.floor(state.mana);
        const types = [];
        if(m>=2) types.push("spark");
        if(m>=3) types.push("scout");
        if(m>=4) types.push("tank");
        if(types.length){
          const t = types[Math.floor(rand(0,types.length))];
          const c = t==="tank"?4:t==="scout"?3:2;
          state.mana = Math.max(0,state.mana-c);
          addUnit("E",Math.floor(rand(0,3)),t);
        }
      }
    }

    function step(dt){
      if(!playing) return;
      state.mana = clamp(state.mana + state.regen*60*dt,0,state.maxMana);
      manaBar.style.width = (state.mana/state.maxMana*100).toFixed(1)+"%";
      ai(dt);
      for(const u of state.units){ u.x += u.spd * u.dir * 60 * dt; }
      state.units = state.units.filter(u=>u.x>0 && u.x<W);
    }

    function draw(){
      ctx.save();
      ctx.scale(scale,scale);
      ctx.fillStyle = "#e7dfb5";
      ctx.fillRect(0,0,W,H);
      ctx.fillStyle = "#8ad1e8";
      ctx.fillRect(0,H*0.55,W,10);
      const drawTower=(t,c)=>{
        ctx.fillStyle=c; ctx.beginPath(); ctx.arc(t.x,t.y,22,0,Math.PI*2); ctx.fill();
        ctx.fillStyle="#4ee46a"; ctx.fillRect(t.x-25,t.y-32,50*(t.hp/t.max),5);
      };
      state.playerTowers.forEach(t=>drawTower(t,"#4b6cb7"));
      state.enemyTowers.forEach(t=>drawTower(t,"#c24b4b"));
      for(const u of state.units){
        ctx.fillStyle=u.team==="P"?"#2f80ed":"#eb5757";
        ctx.beginPath();
        ctx.arc(u.x,u.y,10,0,Math.PI*2);
        ctx.fill();
      }
      ctx.restore();
    }

    function loop(t){
      const dt = Math.min(0.033,(t-last)/1000);
      last = t; step(dt); draw();
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    document.querySelectorAll(".card").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const cost = +btn.dataset.cost, type = btn.dataset.type;
        if(state.mana>=cost && playing){
          addUnit("P",Math.floor(rand(0,3)),type);
          state.mana -= cost;
        }
      });
    });

    document.getElementById("restart").addEventListener("click",()=>{
      state.units.length=0;
      state.mana=5; playing=true;
    });
  </script>
</body>
</html>
