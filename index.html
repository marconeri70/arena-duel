<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Arena Vertical â€“ v4 Real+</title>
<style>
  html,body{margin:0;height:100%;background:#0b0e12;}
  canvas{position:fixed; inset:0; width:100vw; height:100vh; display:block; touch-action:none; -webkit-tap-highlight-color:transparent;}
  .hint{position:fixed;left:0;right:0;top:0;color:#b7d4ff;font:600 14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;text-align:center;pointer-events:none;margin-top:6px;text-shadow:0 1px 2px rgba(0,0,0,.6)}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div class="hint">Tocca il campo per scegliere la corsia â€¢ Tocca una carta per piazzare</div>
<script>
/* ===== Canvas & mapping (portrait) ===== */
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d',{alpha:false});
const W=720,H=1280,UI_H=220,FIELD_H=H-UI_H;
let scale=1,offX=0,offY=0;
function resize(){
  const r=canvas.getBoundingClientRect(), dpr=window.devicePixelRatio||1;
  canvas.width = Math.max(1, Math.round(r.width*dpr));
  canvas.height= Math.max(1, Math.round(r.height*dpr));
  scale = Math.min(canvas.width/W, canvas.height/H);
  offX  = Math.floor((canvas.width - W*scale)/2);
  offY  = Math.floor((canvas.height- H*scale)/2);
}
addEventListener('resize',resize); addEventListener('orientationchange',resize); resize();
function toLogical(ev){
  const r=canvas.getBoundingClientRect();
  const X=(ev.clientX-r.left)*(canvas.width/r.width);
  const Y=(ev.clientY-r.top )*(canvas.height/r.height);
  return {x:(X-offX)/scale, y:(Y-offY)/scale};
}

/* ===== Helpers ===== */
const rand=(a,b)=>a+Math.random()*(b-a);
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));

/* ===== Textures (real+) ===== */
const tex={grass:null,dirt:null,noise:null};
function makePattern(fill,w=128,h=128){
  const c=document.createElement('canvas'); c.width=w; c.height=h;
  const g=c.getContext('2d'); fill(g,w,h); return g.createPattern(c,'repeat');
}
function buildTextures(){
  // perlin-like noise
  const c=document.createElement('canvas'); c.width=128; c.height=128;
  const g=c.getContext('2d'); const id=g.createImageData(128,128);
  for(let y=0;y<128;y++)for(let x=0;x<128;x++){
    const i=(y*128+x)*4, n=(Math.sin(x*.17)+Math.sin(y*.13)+Math.sin((x+y)*.11))*0.33+0.5;
    const v= Math.floor(180*n);
    id.data[i]=v; id.data[i+1]=v; id.data[i+2]=v; id.data[i+3]=18;
  }
  g.putImageData(id,0,0); tex.noise=g.createPattern(c,'repeat');

  // Erba profonda
  tex.grass = makePattern((g,w,h)=>{
    const grd=g.createLinearGradient(0,0,0,h);
    grd.addColorStop(0,'#e9e2b1'); grd.addColorStop(1,'#d0c583');
    g.fillStyle=grd; g.fillRect(0,0,w,h);
    for(let i=0;i<1400;i++){
      g.fillStyle = 'rgba(80,70,35,'+(0.04+Math.random()*0.06)+')';
      g.fillRect(Math.random()*w,Math.random()*h,1,1);
    }
    // lame
    g.strokeStyle='rgba(60,100,40,0.10)'; g.lineWidth=1;
    for(let i=0;i<160;i++){
      const x=Math.random()*w, y=Math.random()*h;
      g.beginPath(); g.moveTo(x,y); g.lineTo(x+rand(-2,2), y-4); g.stroke();
    }
  },256,256);

  // Terra sponda
  tex.dirt = makePattern((g,w,h)=>{
    const grd=g.createLinearGradient(0,0,0,h);
    grd.addColorStop(0,'#cda56f'); grd.addColorStop(1,'#a07843');
    g.fillStyle=grd; g.fillRect(0,0,w,h);
    for(let i=0;i<1000;i++){
      g.fillStyle='rgba(45,25,10,'+(0.05+Math.random()*0.08)+')';
      g.beginPath(); g.arc(Math.random()*w,Math.random()*h,Math.random()*1.6,0,Math.PI*2); g.fill();
    }
  },256,256);
}
buildTextures();

function softShadow(x,y,rx,ry,a=0.25){ ctx.save(); ctx.globalAlpha=a; ctx.fillStyle='#000'; ctx.beginPath(); ctx.ellipse(x,y,rx,ry,0,0,Math.PI*2); ctx.fill(); ctx.restore(); }

/* ===== Game State ===== */
const COL_X=[W*0.18,W*0.5,W*0.82];
const RIVER_Y=FIELD_H*0.5;
let selectedCol=1,last=performance.now(), notEnoughMana=0;
let shake=0, shakex=0, shakey=0; // screen shake

const state={
  manaP:5, manaE:5, manaMax:10, manaRegen:0.016,
  time:0, playing:true, day:0,
  match:{t:0,len:120},
  crowns:{you:0,enemy:0},
  playerTowers:[
    {x:W*0.25,y:FIELD_H-95,hp:100,max:100,range:160,rate:.95,cd:0,recoil:0,muzzle:{x:12,y:-16}},
    {x:W*0.75,y:FIELD_H-95,hp:100,max:100,range:160,rate:.95,cd:0,recoil:0,muzzle:{x:12,y:-16}}
  ],
  enemyTowers:[
    {x:W*0.25,y:95,hp:100,max:100,range:160,rate:.95,cd:0,recoil:0,muzzle:{x:12,y:-16}},
    {x:W*0.75,y:95,hp:100,max:100,range:160,rate:.95,cd:0,recoil:0,muzzle:{x:12,y:-16}}
  ],
  units:[], floats:[], particles:[], projectiles:[], ambient:[]
};

/* ===== SFX ===== */
let ac;
function sfx(kind){ try{
  ac=ac||new (window.AudioContext||window.webkitAudioContext)();
  const o=ac.createOscillator(), g=ac.createGain();
  const map={hit:[210,.05,'square'], place:[660,.06,'square'], win:[880,.35,'triangle'], lose:[160,.35,'triangle'], heal:[520,.07,'sine'], shoot:[780,.045,'triangle'], t_shoot:[520,.055,'square']};
  const [f,t,w]=(map[kind]||[440,.08,'square']); o.type=w; o.frequency.value=f; g.gain.value=.06;
  o.connect(g); g.connect(ac.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+t); o.stop(ac.currentTime+t);
}catch{} }

/* ===== Effects ===== */
function addFloat(x,y,v,c){ state.floats.push({x,y,v,c,t:0}); }
function addHit(x,y,c){ for(let i=0;i<10;i++) state.particles.push({x,y,vx:rand(-1.2,1.2),vy:rand(-1.4,-.1),life:rand(.25,.55),t:0,c}); }
function cameraKick(s=0.9){ shake=Math.min(1,shake+s); }
function damage(t,d){
  if(!('hp' in t)) return;
  t.hp-=d; const c=d>=0?'#ffb36a':'#6afc86';
  addFloat(t.x,t.y-24,(d>=0?'-':'+')+Math.abs(d),c); addHit(t.x,t.y-6,c);
  if(d>0){ cameraKick(.35); } sfx(d>=0?'hit':'heal');
}
function heal(t,a){
  if(!('hp' in t)) return;
  const b=t.hp; t.hp=Math.min(t.max,t.hp+a);
  if(t.hp>b){ addFloat(t.x,t.y-24,'+'+Math.round(t.hp-b),'#6afc86'); sfx('heal'); }
}

/* ===== Units & Projectiles ===== */
function addUnit(team,col,type){
  const x=COL_X[col], y=(team==='P')?FIELD_H-140:140, dir=(team==='P')?-1:1;
  const u={team,x,y,dir,col,type,cd:0,maxhp:1,hp:1,spd:1,atk:1,range:24,rate:1, wob:0};
  if(type==='scout') Object.assign(u,{spd:1.25,hp:16,maxhp:16,atk:3,range:22,rate:.5});
  else if(type==='tank') Object.assign(u,{spd:.7,hp:64,maxhp:64,atk:7,range:28,rate:.95});
  else if(type==='spark') Object.assign(u,{spd:.9,hp:13,maxhp:13,atk:8,range:128,rate:.85});
  else if(type==='healer') Object.assign(u,{spd:1.0,hp:18,maxhp:18,atk:-6,range:100,rate:1.0});
  state.units.push(u); sfx('place');
}
function fireProjectile({x,y}, target, opts){
  const dx=target.x-x, dy=target.y-y, L=Math.hypot(dx,dy)||1;
  const vx=(dx/L)*(opts.speed||440), vy=(dy/L)*(opts.speed||440);
  state.projectiles.push({
    x,y,vx,vy,team:opts.team,heal:!!opts.heal,dmg:opts.dmg??8,life:1.5,
    colorA:opts.colorA||'#fffacd', colorB:opts.colorB||'#7fb6ff', glow:1.0, kind:opts.kind||'unit'
  });
  sfx(opts.kind==='tower'?'t_shoot':'shoot');
}

/* ===== AI ===== */
let aiT=2.0;
function ai(dt){
  aiT-=dt;
  if(aiT<=0 && state.playing){
    aiT=rand(1.2,2.2);
    const m=Math.floor(state.manaE), pool=[];
    if(m>=2) pool.push('spark'); if(m>=3) pool.push('scout','healer'); if(m>=4) pool.push('tank');
    if(pool.length){
      const tp=pool[(Math.random()*pool.length)|0];
      const cost=tp==='tank'?4:(tp==='scout'||tp==='healer'?3:2);
      state.manaE=Math.max(0, state.manaE-cost);
      addUnit('E',(Math.random()*3)|0,tp);
    }
  }
}

/* ===== Logic ===== */
function nearest(u,towers,foes){
  let best=null,score=1e9;
  for(const f of foes){ const s=Math.abs(f.y*u.dir-u.y*u.dir)+Math.abs(f.x-u.x)*.25; if(s<score){score=s;best=f;} }
  if(!best){ let tg=null,sm=1e9; for(const t of towers){ const s=Math.abs(t.y-u.y)+Math.abs(t.x-u.x)*.3; if(t.hp>0 && s<sm){sm=s; tg=t;} } best=tg; }
  return {t:best, dist:best?Math.hypot(best.x-u.x,best.y-u.y):1e9};
}
function towerAI(dt){
  for(const tw of state.playerTowers){
    tw.cd -= dt; tw.recoil *= 0.9;
    if(tw.hp<=0) continue;
    let target=null, best=1e9;
    for(const u of state.units.filter(u=>u.team==='E')){
      if(u.y >= tw.y) continue;
      const d=Math.hypot(u.x-tw.x,u.y-tw.y);
      if(d<tw.range && d<best){best=d; target=u;}
    }
    if(target && tw.cd<=0){
      tw.cd=tw.rate; tw.recoil=1;
      const mx=tw.x+(tw.muzzle?.x||0), my=tw.y+(tw.muzzle?.y||0);
      fireProjectile({x:mx,y:my},target,{team:'P',dmg:7,speed:560,colorA:'#b9d4ff',colorB:'#86b1ff',kind:'tower'});
      addHit(mx,my,'#a7c6ff');
    }
  }
  for(const tw of state.enemyTowers){
    tw.cd -= dt; tw.recoil *= 0.9;
    if(tw.hp<=0) continue;
    let target=null, best=1e9;
    for(const u of state.units.filter(u=>u.team==='P')){
      if(u.y <= tw.y) continue;
      const d=Math.hypot(u.x-tw.x,u.y-tw.y);
      if(d<tw.range && d<best){best=d; target=u;}
    }
    if(target && tw.cd<=0){
      tw.cd=tw.rate; tw.recoil=1;
      const mx=tw.x+(tw.muzzle?.x||0), my=tw.y+(tw.muzzle?.y||0);
      fireProjectile({x:mx,y:my},target,{team:'E',dmg:7,speed:560,colorA:'#ffd2d2',colorB:'#ff9c9c',kind:'tower'});
      addHit(mx,my,'#ffc1c1');
    }
  }
}
function step(dt){
  if(state.playing){
    state.match.t+=dt; state.time+=dt; state.day+=dt*0.025; // ciclo giorno/notte
    if(state.match.t>=state.match.len){ state.playing=false; sfx('lose'); }
    state.manaP = clamp(state.manaP + state.manaRegen*60*dt, 0, state.manaMax);
    state.manaE = clamp(state.manaE + state.manaRegen*60*dt, 0, state.manaMax);
    ai(dt); towerAI(dt);
  }

  // ambient foglie/lucciole
  if(state.ambient.length<40 && Math.random()<0.05){
    state.ambient.push({x:rand(0,W), y:rand(40,FIELD_H-40), r:rand(0.8,1.8), a:rand(0.2,0.6), t:0, kind:(Math.random()<0.5?'dust':'firefly')});
  }
  for(const a of state.ambient){ a.t+=dt; a.x+=Math.sin(a.t*2)*.2; a.y+=Math.cos(a.t*1.6)*.1; }
  state.ambient=state.ambient.filter(a=>a.t<8);

  // Units
  for(const u of state.units){
    const enemy = u.team==='P' ? 'E' : 'P';
    const foes  = state.units.filter(x=>x.team===enemy && x.col===u.col);
    const towers= (enemy==='E'?state.enemyTowers:state.playerTowers).filter(t=>Math.abs(t.x-u.x)<W*0.35);
    const allies= state.units.filter(x=>x.team===u.team && x.col===u.col);
    const allyT = (u.team==='P'?state.playerTowers:state.enemyTowers).filter(t=>Math.abs(t.x-u.x)<W*0.35);
    u.cd-=dt; u.wob+=dt*6;

    if(u.type==='healer'){
      let tgt=null, bestGap=0;
      for(const a of allies){
        const gap=a.maxhp-a.hp, d=Math.hypot(a.x-u.x,a.y-u.y);
        if(gap>bestGap && d<=u.range){ bestGap=gap; tgt=a; }
      }
      for(const t of allyT){
        const gap=t.max-t.hp, d=Math.hypot(t.x-u.x,t.y-u.y);
        if(gap>bestGap && d<=u.range){ bestGap=gap; tgt=t; }
      }
      if(tgt && u.cd<=0){
        u.cd=u.rate;
        fireProjectile(u,tgt,{team:u.team,heal:true,dmg:Math.abs(u.atk),speed:380,colorA:'#baffc9',colorB:'#47e97a'});
      }else{
        u.y += u.spd*u.dir*60*dt;
      }
    }else if(u.type==='spark'){
      const {t,dist}=nearest(u,towers,foes);
      if(t && dist<=u.range){
        if(u.cd<=0){
          u.cd=u.rate;
          fireProjectile(u,t,{team:u.team,heal:false,dmg:u.atk,speed:540,colorA:'#fffacd',colorB:(u.team==='P')?'#7fb6ff':'#ff9b9b'});
        }
      }else u.y += u.spd*u.dir*60*dt;
    }else{
      const {t,dist}=nearest(u,towers,foes);
      if(t && dist<=u.range){ if(u.cd<=0){u.cd=u.rate; damage(t,u.atk);} }
      else u.y += u.spd*u.dir*60*dt;
    }
  }

  // Projectiles
  for(const p of state.projectiles){
    p.life-=dt; p.x+=p.vx*dt; p.y+=p.vy*dt; p.glow*=0.985;
    let hit=null;
    for(const u of state.units){
      if((p.heal && u.team!==p.team) || (!p.heal && u.team===p.team)) continue;
      if(Math.hypot(u.x-p.x,u.y-p.y)<14){ hit=u; break; }
    }
    if(!hit){
      const towers = p.heal ? (p.team==='P'?state.playerTowers:state.enemyTowers)
                            : (p.team==='P'?state.enemyTowers:state.playerTowers);
      for(const t of towers){ if(Math.hypot(t.x-p.x,t.y-p.y)<22){ hit=t; break; } }
    }
    if(hit){ (p.heal?heal:damage)(hit,p.dmg); p.life=0; }
  }
  state.projectiles = state.projectiles.filter(p=>p.life>0 && p.x>-30 && p.x<W+30 && p.y>-30 && p.y<FIELD_H+30);

  // Cleanup & end
  state.units = state.units.filter(u=>u.hp>0 && u.y>40 && u.y<FIELD_H-40);
  for(const f of state.floats){ f.t+=dt; f.y-=24*dt; } state.floats=state.floats.filter(f=>f.t<.9);
  for(const p of state.particles){ p.t+=dt; p.x+=p.vx*60*dt; p.y+=p.vy*60*dt; p.vy+=.04; } state.particles=state.particles.filter(p=>p.t<p.life);

  const pAlive=state.playerTowers.filter(t=>t.hp>0).length;
  const eAlive=state.enemyTowers.filter(t=>t.hp>0).length;
  state.crowns.you   = 2 - eAlive;
  state.crowns.enemy = 2 - pAlive;
  if(state.playing && (pAlive===0 || eAlive===0)){ state.playing=false; sfx(eAlive===0?'win':'lose'); }
}

/* ===== Rendering (Real+) ===== */
function vignette(){
  const g=ctx.createRadialGradient(W/2,FIELD_H/2,Math.min(W,FIELD_H)*.35,W/2,FIELD_H/2,Math.max(W,FIELD_H)*.9);
  g.addColorStop(0,'rgba(0,0,0,0)'); g.addColorStop(1,'rgba(0,0,0,0.22)');
  ctx.fillStyle=g; ctx.fillRect(0,0,W,FIELD_H);
}
function dayNightOverlay(){
  const t=(Math.sin(state.day)+1)/2; // 0 notte â€“ 1 giorno
  const sky=ctx.createLinearGradient(0,0,0,FIELD_H);
  sky.addColorStop(0,`rgba(${Math.round(20+80*t)},${Math.round(40+80*t)},${Math.round(70+100*t)},0.28)`);
  sky.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=sky; ctx.fillRect(0,0,W,FIELD_H);
}
function bg(){
  // parallax erboso
  ctx.fillStyle=tex.grass; ctx.fillRect(0,0,W,FIELD_H);
  ctx.save(); ctx.globalAlpha=.10; ctx.fillStyle=tex.noise; ctx.fillRect(0,0,W,FIELD_H); ctx.restore();

  // griglia
  ctx.strokeStyle='#00000012'; ctx.lineWidth=1; ctx.beginPath();
  for(let y=0;y<=FIELD_H;y+=64){ ctx.moveTo(0,y); ctx.lineTo(W,y); }
  for(let x=0;x<=W;x+=80){ ctx.moveTo(x,0); ctx.lineTo(x,FIELD_H); }
  ctx.stroke();

  // corsie
  ctx.strokeStyle='#a99f72cc'; ctx.lineWidth=2;
  for(const x of COL_X){ ctx.beginPath(); ctx.moveTo(x,24); ctx.lineTo(x,FIELD_H-24); ctx.stroke(); }

  // sponde
  ctx.fillStyle=tex.dirt; ctx.fillRect(0,RIVER_Y-30,W,14); ctx.fillRect(0,RIVER_Y+16,W,14);

  // acqua con riflessi
  const t=state.time||0, h=26;
  const grad=ctx.createLinearGradient(0,RIVER_Y-h/2,0,RIVER_Y+h/2);
  grad.addColorStop(0,'#bfefff'); grad.addColorStop(.5,'#7dcae6'); grad.addColorStop(1,'#5ab3d3');
  ctx.fillStyle=grad; ctx.fillRect(0,RIVER_Y-h/2,W,h);
  ctx.save(); ctx.globalAlpha=0.24; ctx.fillStyle='#ffffff';
  for(let i=0;i<3;i++){
    ctx.beginPath(); ctx.moveTo(0,RIVER_Y+Math.sin(t*1.2+i)*3);
    for(let x=0;x<=W;x+=12){ const y = RIVER_Y + Math.sin((x*0.02)+(t*1.2+i))*3; ctx.lineTo(x,y); }
    ctx.lineTo(W,RIVER_Y+h/2); ctx.lineTo(0,RIVER_Y+h/2); ctx.closePath(); ctx.fill();
  }
  ctx.restore();

  // ponti
  const bridge=(cx)=>{
    softShadow(cx,RIVER_Y+14,72,12,0.3);
    ctx.save(); ctx.translate(cx,RIVER_Y);
    const g=ctx.createLinearGradient(-66,-18,-66,18);
    g.addColorStop(0,'#a86a33'); g.addColorStop(1,'#7a4a22');
    ctx.fillStyle=g; ctx.fillRect(-66,-18,132,36);
    ctx.strokeStyle='#5d3b1d'; ctx.lineWidth=3; ctx.strokeRect(-66,-18,132,36);
    ctx.strokeStyle='#6d461f';
    for(let i=-60;i<=60;i+=14){ ctx.beginPath(); ctx.moveTo(i,-18); ctx.lineTo(i,18); ctx.stroke(); }
    ctx.fillStyle='rgba(255,255,255,0.18)'; ctx.fillRect(-66,-18,132,4);
    ctx.restore();
  };
  bridge(W*0.3); bridge(W*0.7);

  // corsia selezionata
  ctx.fillStyle='#1a7fff22'; ctx.fillRect(COL_X[selectedCol]-W*0.16,0,W*0.32,FIELD_H);

  // overlay
  dayNightOverlay();
  vignette();

  // particelle ambiente
  for(const a of state.ambient){
    if(a.kind==='firefly'){
      const glow=ctx.createRadialGradient(a.x,a.y,0,a.x,a.y,10);
      glow.addColorStop(0,'rgba(255,255,180,0.9)');
      glow.addColorStop(1,'rgba(255,255,180,0)');
      ctx.save(); ctx.globalAlpha=a.a*(0.6+Math.sin(a.t*6)*0.4); ctx.fillStyle=glow;
      ctx.beginPath(); ctx.arc(a.x,a.y,4,0,Math.PI*2); ctx.fill(); ctx.restore();
    }else{
      ctx.save(); ctx.globalAlpha=a.a*0.6; ctx.fillStyle='#ffffff';
      ctx.fillRect(a.x,a.y,1,1); ctx.restore();
    }
  }
}
function tower(t,friendly){
  const recoilY= -t.recoil*2;
  softShadow(t.x,t.y+12,30,10,0.3);
  const body=ctx.createLinearGradient(t.x,t.y-26,t.x,t.y+26);
  body.addColorStop(0,'#d6dee8'); body.addColorStop(.5,'#b7c2cf'); body.addColorStop(1,'#a5b1bf');
  ctx.fillStyle=body; ctx.beginPath(); ctx.ellipse(t.x,t.y+recoilY,26,24,0,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='#8795a6'; ctx.lineWidth=3; ctx.beginPath(); ctx.ellipse(t.x,t.y+recoilY,26,24,0,0,Math.PI*2); ctx.stroke();

  ctx.save(); ctx.shadowColor='rgba(0,0,0,.25)'; ctx.shadowBlur=8;
  ctx.fillStyle = friendly ? '#3b7ae0' : '#d14f4f'; ctx.beginPath(); ctx.arc(t.x,t.y+recoilY,18,0,Math.PI*2); ctx.fill(); ctx.restore();

  ctx.fillStyle='#1e2935'; ctx.fillRect(t.x-6,t.y-3+recoilY,12,10);

  // bagliore museruola
  if(t.recoil>0.2){
    const mx=t.x+(t.muzzle?.x||0), my=t.y+(t.muzzle?.y||0)+recoilY;
    const flame=ctx.createRadialGradient(mx,my,0,mx,my,14);
    flame.addColorStop(0, friendly?'rgba(170,210,255,0.9)':'rgba(255,190,160,0.9)');
    flame.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=flame; ctx.beginPath(); ctx.arc(mx,my,14,0,Math.PI*2); ctx.fill();
  }

  const sway=Math.sin(state.time*2+t.x)*3;
  ctx.fillStyle = friendly ? '#6fe0ff' : '#ffd46f';
  ctx.beginPath(); ctx.moveTo(t.x+24,t.y-14+recoilY); ctx.lineTo(t.x+24+18+sway,t.y-18+recoilY); ctx.lineTo(t.x+24,t.y-22+recoilY); ctx.closePath(); ctx.fill();

  const w=78,h=8; ctx.fillStyle='rgba(0,0,0,.50)'; ctx.fillRect(t.x-w/2,t.y-40+recoilY,w,h);
  const hp=ctx.createLinearGradient(t.x-w/2,0,t.x+w/2,0); hp.addColorStop(0,'#6be675'); hp.addColorStop(1,'#32c24b');
  ctx.fillStyle=hp; ctx.fillRect(t.x-w/2,t.y-40+recoilY,w*clamp(t.hp/t.max,0,1),h);
}
function drawUnit(u){
  // scia & ombra
  ctx.save(); ctx.globalAlpha=0.16; ctx.fillStyle=(u.team==='P')?'#7fb6ff':'#ff9b9b';
  ctx.beginPath(); ctx.ellipse(u.x - u.dir*10, u.y+10, 18, 6, 0, 0, Math.PI*2); ctx.fill(); ctx.restore();
  softShadow(u.x,u.y+8,16,6,0.28);

  const edge=(u.team==='P')?'#0b4ea2':'#9b1c1c';
  const core=(u.team==='P')?'#2f80ed':'#eb5757';
  const wob=Math.sin(u.wob)*2;

  ctx.lineWidth=2; ctx.strokeStyle=edge;
  if(u.type==='tank'){
    const grd=ctx.createLinearGradient(u.x,u.y-12,u.x,u.y+12);
    grd.addColorStop(0,'#b1b6bf'); grd.addColorStop(1,core);
    ctx.fillStyle=grd; ctx.fillRect(u.x-20,u.y-13+wob,40,26); ctx.strokeRect(u.x-20,u.y-13+wob,40,26);
    ctx.fillStyle='#00000022'; ctx.fillRect(u.x-20,u.y-13+wob,40,6);
  }else if(u.type==='scout'){
    const g=ctx.createRadialGradient(u.x,u.y,2,u.x,u.y,14);
    g.addColorStop(0,'#ffffff'); g.addColorStop(1,core);
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(u.x,u.y+wob*0.5,12,0,Math.PI*2); ctx.fill(); ctx.stroke();
  }else if(u.type==='spark'){
    const g=ctx.createRadialGradient(u.x,u.y,2,u.x,u.y,18);
    g.addColorStop(0,'#fffacd'); g.addColorStop(1,(u.team==='P')?'#7fb6ff':'#ff9b9b');
    ctx.fillStyle=g; ctx.beginPath(); ctx.moveTo(u.x-14,u.y+12+wob); ctx.lineTo(u.x+14,u.y+12+wob); ctx.lineTo(u.x,u.y-14+wob); ctx.closePath(); ctx.fill();
    ctx.strokeStyle=edge; ctx.stroke();
    ctx.save(); ctx.globalAlpha=0.22; ctx.fillStyle=g; ctx.beginPath(); ctx.arc(u.x,u.y,20,0,Math.PI*2); ctx.fill(); ctx.restore();
  }else{ // healer
    ctx.fillStyle='#7cd37c'; ctx.beginPath(); ctx.arc(u.x,u.y+wob*0.6,12,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='#2d7a2d'; ctx.stroke();
    ctx.fillStyle='#2d7a2d'; ctx.fillRect(u.x-2,u.y-8+wob*0.6,4,16); ctx.fillRect(u.x-8,u.y-2+wob*0.6,16,4);
  }

  // barra HP
  const ratio=clamp(u.hp/u.maxhp,0,1);
  ctx.fillStyle='rgba(0,0,0,.5)'; ctx.fillRect(u.x-12,u.y-24,24,5);
  const g2=ctx.createLinearGradient(u.x-12,0,u.x+12,0); g2.addColorStop(0,'#7af07a'); g2.addColorStop(1,'#40c15b');
  ctx.fillStyle=g2; ctx.fillRect(u.x-12,u.y-24,24*ratio,5);
}
function drawProjectiles(){
  for(const p of state.projectiles){
    // scia
    ctx.save(); ctx.globalAlpha=0.32*p.glow;
    const trail=ctx.createLinearGradient(p.x - p.vx*0.03, p.y - p.vy*0.03, p.x, p.y);
    trail.addColorStop(0,'rgba(255,255,255,0)');
    trail.addColorStop(1,p.colorB);
    ctx.strokeStyle=trail; ctx.lineWidth=3.2; ctx.beginPath();
    ctx.moveTo(p.x - p.vx*0.03, p.y - p.vy*0.03); ctx.lineTo(p.x, p.y); ctx.stroke();
    ctx.restore();

    // glow
    const glow=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,9);
    glow.addColorStop(0,p.colorA); glow.addColorStop(1,'rgba(255,255,255,0)');
    ctx.save(); ctx.globalAlpha=0.95*p.glow; ctx.fillStyle=glow; ctx.beginPath(); ctx.arc(p.x,p.y,6.5,0,Math.PI*2); ctx.fill(); ctx.restore();

    // punta
    ctx.fillStyle=p.colorB; ctx.beginPath(); ctx.arc(p.x,p.y,2.4,0,Math.PI*2); ctx.fill();
  }
}
function drawCrowns(){
  ctx.fillStyle='#0f1115cc'; ctx.fillRect(0,0,W,26);
  ctx.font='bold 15px system-ui'; ctx.textAlign='left'; ctx.fillStyle='#ffd966';
  ctx.fillText('ðŸ”± '+state.crowns.you, 10, 18);
  ctx.textAlign='right'; ctx.fillText(state.crowns.enemy+' ðŸ”±', W-10, 18);
}

/* ===== UI ===== */
const cards=[
  {label:'Scout',cost:3,type:'scout', color:'#79a8ff'},
  {label:'Tank', cost:4,type:'tank',  color:'#ffb36a'},
  {label:'Spark',cost:2,type:'spark', color:'#c6d6ff'},
  {label:'Healer',cost:3,type:'healer',color:'#98f0b1'},
  {label:'Riavvia',cost:0,type:'restart',color:'#b0b7c6'},
];
const cardRects=[];
function drawManaBar(){
  const x=24,y=FIELD_H+18,w=W-48,h=16;
  const m=state.manaP,M=state.manaMax;
  // cornice glass
  ctx.fillStyle='rgba(16,22,30,.8)'; ctx.fillRect(x,y,w,h);
  const g=ctx.createLinearGradient(x,0,x+w,0); g.addColorStop(0,'#6fe0ff'); g.addColorStop(1,'#2b74ff');
  ctx.fillStyle=g; ctx.fillRect(x,y,w*(m/M),h);
  ctx.fillStyle='#ffffff20'; ctx.fillRect(x,y, w,2);
  ctx.fillStyle='#00000040'; ctx.fillRect(x,y+h-2, w,2);
  ctx.font='700 14px system-ui'; ctx.textAlign='left'; ctx.fillStyle='#cfe1ff';
  ctx.fillText('Mana: '+Math.floor(m)+' / '+M, x, y-6);
  if(notEnoughMana>0){
    ctx.save(); ctx.globalAlpha=Math.min(1,notEnoughMana);
    ctx.fillStyle='#ff9b9b'; ctx.fillText('Mana insufficiente!', x+160, y-6); ctx.restore();
  }
}
function drawCards(){
  const pad=16, h=86, y=FIELD_H+44; cardRects.length=0;
  const total=cards.length, w=(W - pad*2 - (total-1)*12)/total;
  ctx.textAlign='center';
  for(let i=0;i<total;i++){
    const x=pad + i*(w+12);
    cardRects.push({x,y,w,h,i});
    const c=cards[i];
    // pannello
    ctx.save();
    ctx.shadowColor='rgba(0,0,0,.35)'; ctx.shadowBlur=12; ctx.shadowOffsetY=6;
    ctx.fillStyle='rgba(20,28,36,.85)'; ctx.fillRect(x,y,w,h);
    ctx.restore();
    // gloss
    const gloss=ctx.createLinearGradient(0,y,0,y+h);
    gloss.addColorStop(0,'rgba(255,255,255,0.16)');
    gloss.addColorStop(.6,'rgba(255,255,255,0.04)');
    gloss.addColorStop(1,'rgba(255,255,255,0.0)');
    ctx.fillStyle=gloss; ctx.fillRect(x,y,w,h*0.45);

    // titolo + costo pill
    ctx.font='700 17px system-ui'; ctx.fillStyle='#dfe8ff';
    ctx.fillText(c.label, x+w/2, y+24);
    ctx.font='600 14px system-ui';
    // pill costo
    const pillW=44, pillH=22, px=x+w/2-pillW/2, py=y+h-26;
    ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillRect(px,py,pillW,pillH);
    ctx.fillStyle=c.color; ctx.fillText(c.cost?(''+c.cost):'â†»', x+w/2, py+15);
  }
}
function ui(){
  ctx.fillStyle='#0a1118'; ctx.fillRect(0,FIELD_H,W,UI_H);
  drawManaBar();
  drawCards();
}

/* ===== Input ===== */
canvas.addEventListener('pointerdown',ev=>{
  const p=toLogical(ev);
  if(p.y<FIELD_H){
    let idx=0, best=1e9;
    for(let i=0;i<3;i++){ const d=Math.abs(p.x-COL_X[i]); if(d<best){best=d; idx=i;} }
    selectedCol=idx; return;
  }
  for(const r of cardRects){
    if(p.x>=r.x && p.x<=r.x+r.w && p.y>=r.y && p.y<=r.y+r.h){
      const card=cards[r.i];
      if(card.type==='restart'){ restart(); return; }
      if(state.manaP>=card.cost){
        state.manaP-=card.cost;
        addUnit('P', selectedCol, card.type);
      }else notEnoughMana=1.2;
      return;
    }
  }
});

/* ===== Restart ===== */
function restart(){
  state.units.length=0; state.floats.length=0; state.particles.length=0; state.projectiles.length=0; state.ambient.length=0;
  for(const t of state.playerTowers){ t.hp=t.max; t.cd=0; t.recoil=0; }
  for(const t of state.enemyTowers){ t.hp=t.max; t.cd=0; t.recoil=0; }
  state.manaP=5; state.manaE=5; state.time=0; state.match.t=0; state.day=0; state.playing=true;
}

/* ===== Main loop with screen shake ===== */
function frame(now){
  const dt=Math.min(0.05,(now-last)/1000); last=now;
  // screen shake decay
  if(shake>0){ shake*=0.88; shakex=(Math.random()-0.5)*4*shake; shakey=(Math.random()-0.5)*4*shake; } else {shakex=0; shakey=0;}
  ctx.save();
  ctx.setTransform(scale,0,0,scale,offX+shakex,offY+shakey);

  // clear
  ctx.fillStyle='#0b0e12'; ctx.fillRect(-offX/scale,-offY/scale,canvas.width/scale,canvas.height/scale);

  // update
  if(notEnoughMana>0) notEnoughMana-=dt;
  step(dt);

  // draw
  bg();
  state.enemyTowers.forEach(t=>tower(t,false));
  state.playerTowers.forEach(t=>tower(t,true));
  state.units.forEach(drawUnit);
  drawProjectiles();

  // particles
  for(const p of state.particles){ ctx.fillStyle=p.c; ctx.globalAlpha=1-(p.t/p.life); ctx.fillRect(p.x,p.y,2.2,2.2); ctx.globalAlpha=1; }
  // floats
  ctx.font='bold 15px system-ui'; ctx.textAlign='center';
  for(const f of state.floats){ ctx.fillStyle=f.c; ctx.globalAlpha=1-f.t; ctx.fillText(f.v, f.x, f.y); ctx.globalAlpha=1; }

  drawCrowns();
  ui();

  ctx.restore();
  requestAnimationFrame(frame);
}
requestAnimationFrame(frame);
</script>
</body>
</html>
